# PO18 小说下载站

一个基于 Node.js 的 PO18 小说下载、管理和共享平台，支持多用户、书库管理、WebDAV 同步和共享书库功能。

## 功能特性

### 核心功能
- **📚 小说下载**：支持 TXT、EPUB 格式下载，自动解析章节内容
- **🔍 智能搜索**：支持书名、作者搜索，可搜索元信息库和共享书库
- **📖 书库管理**：个人书库管理，支持分类、标签筛选
- **☁️ WebDAV 同步**：自动上传至 WebDAV 服务器（如 Alist）
- **🤝 共享书库**：用户间共享书籍，共享 3 本以上可访问他人共享
- **📊 排行榜**：支持留言、收藏、月人气、总人气、最近更新等榜单

### 高级特性
- **⚡ 并发下载**：8 线程并发，参考油猴脚本优化下载速度
- **🔄 智能重试**：请求失败自动重试，超时快速重试机制
- **💾 元信息缓存**：书籍元信息本地缓存，减少重复请求
- **🎨 Material Design**：现代化 UI 设计，支持响应式布局
- **👥 多用户系统**：支持用户注册、登录，数据隔离
- **🔐 Cookie 管理**：支持配置 PO18 Cookie 访问已购书籍

## 技术栈

- **后端**：Node.js + Express
- **数据库**：SQLite3 (better-sqlite3)
- **爬虫**：Axios + Cheerio
- **前端**：原生 JavaScript + Material Design
- **文件生成**：epub-gen (EPUB)、自定义 TXT 生成器
- **WebDAV**：webdav 客户端库

## 快速开始

### 安装依赖
```bash
npm install
```

### 启动服务
```bash
npm start
```

开发模式（自动重启）：
```bash
npm run dev
```

访问地址：`http://localhost:3000`

## 项目结构

```
po18-web/
├── server/              # 后端代码
│   ├── app.js          # 应用入口
│   ├── routes.js       # API 路由
│   ├── crawler.js      # PO18 爬虫模块
│   ├── database.js     # 数据库操作
│   ├── webdav.js       # WebDAV 客户端
│   └── config.js       # 配置文件
├── public/             # 前端静态文件
│   ├── index.html      # 主页面
│   ├── admin.html      # 后台管理
│   ├── rankings.html   # 排行榜页面
│   ├── css/           # 样式文件
│   └── js/            # 前端脚本
├── data/              # 数据库文件
├── shared/            # 共享书库文件
├── temp/              # 临时文件
└── scripts/           # 工具脚本

```

## 配置说明

### PO18 Cookie
登录后在设置中配置 PO18 Cookie，用于访问已购书籍。

### WebDAV 配置
支持上传至 WebDAV 服务器，配置项包括：
- URL：WebDAV 服务器地址
- 用户名：认证用户名
- 密码：认证密码
- 书库路径：上传路径（默认：`/书库`）

### 共享书库
- 启用共享后可将书籍分享给其他用户
- 共享 3 本以上可访问他人共享的书库
- 共享文件存储在 `/server/shared` 目录

## 主要功能模块

### 1. 快速下载
- 支持书籍 ID 或链接快速下载
- 支持批量解析和上传
- 实时显示下载进度
- 下载完成后自动触发浏览器下载

### 2. 已购书籍
- 自动获取 PO18 已购书籍列表
- 支持按年份分页加载
- 显示书籍详情、购买时间、章节数等
- 一键下载已购书籍

### 3. 下载管理
- 队列管理：查看下载队列和进度
- 下载历史：记录所有下载记录
- 支持清空历史和已完成任务

### 4. 我的书库
- 个人书库管理
- 支持分类、作者、格式筛选
- 支持重新下载和共享操作
- WebDAV 自动同步

### 5. 排行榜
- 留言榜：留言数排行
- 收藏榜：收藏数排行
- 月人气榜：月人气排行
- 总人气榜：总人气排行
- 最近更新榜：更新时间排行

### 6. 后台管理（Admin 权限）
- 用户管理
- 元信息数据库管理
- 批量 ID 遍历和解析
- 数据库清理和维护

## 更新记录

### v1.1.0 (2024-12-14)

#### 新增功能
- ✅ 书籍详情页（book-detail.html）
  - 显示完整的书籍元信息（收藏、留言、人气等）
  - 章节列表（支持正序/倒序）
  - 在线阅读功能（弹窗阅读器）
  - 章节预加载
  - 付费章节🔒标识
  - 评论分页显示
  - 下载功能集成
- ✅ 书名点击跳转详情页
  - 解析后的书籍支持跳转
  - 排行榜书籍支持跳转
  - 已购书籍支持跳转
  - 书库书籍支持跳转

#### API 增强
- ✅ POST /api/parse/book - 获取书籍详情
- ✅ POST /api/parse/chapters - 获取章节列表
- ✅ POST /api/parse/chapter-content - 获取章节内容

### v1.0.0 (2024-12)

#### 新增功能
- ✅ 完整的用户系统（注册、登录、多用户）
- ✅ PO18 小说下载（TXT、EPUB 格式）
- ✅ 已购书籍自动获取和管理
- ✅ WebDAV 自动上传功能
- ✅ 共享书库系统
- ✅ 排行榜页面（留言、收藏、人气、更新）
- ✅ 后台管理界面
- ✅ 元信息数据库和缓存机制

#### 性能优化
- ✅ 并发下载优化（3→8 线程）
- ✅ 请求超时优化（30s→12s）
- ✅ 智能重试机制（超时 500ms 快速重试）
- ✅ 移除请求延迟（500ms→0ms）
- ✅ 章节列表并发获取

#### 用户体验
- ✅ 浏览器直接下载（不保存服务器本地）
- ✅ 共享库状态持久化
- ✅ 页面刷新保持状态
- ✅ 未登录默认显示排行榜
- ✅ 搜索结果限制 20 条防止卡顿
- ✅ Material Design UI

#### 数据库优化
- ✅ purchased_books 表字段扩展
- ✅ 下载历史去重（1 分钟窗口）
- ✅ 书籍元信息缓存
- ✅ 数据库自动迁移机制

## TODO

### 近期计划
- [x] 书籍详情页优化（显示更多元信息）
- [x] 在线阅读功能
- [ ] 下载队列并发控制（限制同时下载数）
- [ ] 支持更多下载格式（MOBI、AZW3）
- [ ] 书库导出功能（批量打包）
- [ ] 书籍标签系统优化

### 中期计划
- [ ] 阅读进度同步
- [ ] 书评和评分系统
- [ ] 更多排行榜维度（完结榜、新书榜等）
- [ ] 书籍推荐算法
- [ ] 移动端适配优化

### 长期计划
- [ ] 支持其他小说站点
- [ ] 书籍自动更新检测
- [ ] RSS 订阅功能
- [ ] Docker 部署支持

## 注意事项

1. **合法使用**：本项目仅供学习交流，请勿用于商业用途
2. **Cookie 安全**：PO18 Cookie 为敏感信息，请妥善保管
3. **数据备份**：定期备份 `data/` 目录下的数据库文件
4. **共享规则**：请勿共享违规内容
5. **性能建议**：大量下载时建议配置 WebDAV 避免本地存储压力

## 常见问题

### 1. 下载失败怎么办？
- 检查 PO18 Cookie 是否有效
- 检查网络连接是否正常
- 查看是否需要在 PO18 购买该书籍

### 2. WebDAV 上传失败？
- 检查 WebDAV 配置是否正确
- 确认服务器地址、用户名、密码
- 检查书库路径是否存在

### 3. 共享书库看不到内容？
- 确认已启用共享功能
- 检查是否已共享至少 3 本书籍
- 刷新页面重新加载

### 4. 页面卡顿怎么办？
- 搜索结果已限制 20 条
- 避免同时下载过多书籍
- 清理下载历史记录

## 许可证

MIT License

## 贡献

欢迎提交 Issue 和 Pull Request！

---

**免责声明**：本项目仅供学习交流使用，请遵守相关法律法规，尊重版权。
