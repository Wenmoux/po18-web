<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO18å·²è´­ä¹¦ç±æ‰¹é‡å¯¼å…¥å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .logs {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-item {
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .log-item:last-child {
            border-bottom: none;
        }
        
        .log-time {
            color: #999;
            margin-right: 10px;
        }
        
        .log-info { color: #333; }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-warning { color: #ffc107; }
        
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            width: 0%;
        }
        
        .help-text {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .help-text h4 {
            margin-bottom: 10px;
            color: #856404;
        }
        
        .help-text ol {
            margin-left: 20px;
        }
        
        .help-text li {
            margin-bottom: 5px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š PO18å·²è´­ä¹¦ç±æ‰¹é‡å¯¼å…¥å·¥å…·</h1>
            <p>ä¸€é”®å¯¼å…¥æ‰€æœ‰å·²è´­ä¹¦ç±å…ƒä¿¡æ¯åˆ°æœ¬åœ°æ•°æ®åº“</p>
        </div>
        
        <div class="content">
            <div class="help-text">
                <h4>ä½¿ç”¨è¯´æ˜ï¼š</h4>
                <ol>
                    <li>åœ¨PO18ç½‘ç«™ç™»å½•åï¼Œè®¿é—®å·²è´­ä¹¦æ¶é¡µé¢</li>
                    <li>é…ç½®æœ¬åœ°APIåœ°å€ï¼ˆé»˜è®¤ï¼šhttp://localhost:3000ï¼‰</li>
                    <li>ç‚¹å‡»"å¼€å§‹éå†"æŒ‰é’®ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨éå†æ‰€æœ‰åˆ†é¡µ</li>
                    <li>éå†å®Œæˆåï¼Œç‚¹å‡»"æ‰¹é‡ä¸Šä¼ "å°†æ•°æ®å‘é€åˆ°æœ¬åœ°æœåŠ¡å™¨</li>
                </ol>
            </div>
            
            <div class="form-group">
                <label>æœ¬åœ°APIåœ°å€</label>
                <input type="text" id="api-url" value="http://localhost:3000" placeholder="http://localhost:3000">
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" id="start-btn">å¼€å§‹éå†</button>
                <button class="btn btn-secondary" id="upload-btn" disabled>æ‰¹é‡ä¸Šä¼ </button>
                <button class="btn btn-secondary" id="clear-btn">æ¸…ç©ºæ•°æ®</button>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-count">0</div>
                    <div class="stat-label">å·²æ”¶é›†ä¹¦ç±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="page-count">0</div>
                    <div class="stat-label">å·²éå†é¡µæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="upload-count">0</div>
                    <div class="stat-label">å·²ä¸Šä¼ </div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
            
            <div class="logs" id="logs">
                <div class="log-item log-info">
                    <span class="log-time">[å¾…å¼€å§‹]</span>
                    <span>å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹éå†"æŒ‰é’®å¼€å§‹</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let collectedBooks = [];
        let currentPage = 1;
        let isRunning = false;
        
        // DOMå…ƒç´ 
        const startBtn = document.getElementById('start-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const clearBtn = document.getElementById('clear-btn');
        const logsDiv = document.getElementById('logs');
        const apiUrlInput = document.getElementById('api-url');
        const totalCountEl = document.getElementById('total-count');
        const pageCountEl = document.getElementById('page-count');
        const uploadCountEl = document.getElementById('upload-count');
        const progressBar = document.getElementById('progress');
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span>${message}</span>
            `;
            logsDiv.insertBefore(logItem, logsDiv.firstChild);
            
            // åªä¿ç•™æœ€æ–°100æ¡
            while (logsDiv.children.length > 100) {
                logsDiv.removeChild(logsDiv.lastChild);
            }
        }
        
        // è§£æä¹¦ç±ä¿¡æ¯
        function parseBookInfo(bookElement) {
            try {
                // è§£æä¹¦ç±IDï¼ˆä»é“¾æ¥ä¸­æå–ï¼‰
                const link = bookElement.querySelector('a[href*="/books/"]');
                if (!link) return null;
                
                const match = link.href.match(/\/books\/(\d+)/);
                if (!match) return null;
                
                const bookId = match[1];
                
                // è§£æä¹¦å
                const titleEl = bookElement.querySelector('.book-title, .title, h3, h4');
                const title = titleEl ? titleEl.textContent.trim() : '';
                
                // è§£æä½œè€…
                const authorEl = bookElement.querySelector('.author, .book-author');
                const author = authorEl ? authorEl.textContent.replace(/ä½œè€…[ï¼š:]/g, '').trim() : '';
                
                // è§£æå°é¢
                const coverEl = bookElement.querySelector('img');
                const cover = coverEl ? coverEl.src : '';
                
                // è§£ææ ‡ç­¾
                const tagEls = bookElement.querySelectorAll('.tag, .label');
                const tags = Array.from(tagEls).map(el => el.textContent.trim()).join('Â·');
                
                return {
                    bookId,
                    title,
                    author,
                    cover,
                    tags,
                    detailUrl: `https://www.po18.tw/books/${bookId}/articles`
                };
            } catch (error) {
                console.error('è§£æä¹¦ç±ä¿¡æ¯å¤±è´¥:', error);
                return null;
            }
        }
        
        // éå†å½“å‰é¡µé¢çš„ä¹¦ç±
        async function scrapePage() {
            try {
                // æŸ¥æ‰¾ä¹¦ç±åˆ—è¡¨å®¹å™¨ï¼ˆæ ¹æ®å®é™…é¡µé¢ç»“æ„è°ƒæ•´é€‰æ‹©å™¨ï¼‰
                const bookElements = document.querySelectorAll('.book-item, .book, .item, li[class*="book"]');
                
                if (bookElements.length === 0) {
                    log('å½“å‰é¡µé¢æ²¡æœ‰æ‰¾åˆ°ä¹¦ç±å…ƒç´ ï¼Œè¯·æ£€æŸ¥é€‰æ‹©å™¨', 'warning');
                    return [];
                }
                
                const books = [];
                bookElements.forEach(el => {
                    const book = parseBookInfo(el);
                    if (book && book.bookId) {
                        books.push(book);
                    }
                });
                
                return books;
            } catch (error) {
                log(`è§£æé¡µé¢å¤±è´¥: ${error.message}`, 'error');
                return [];
            }
        }
        
        // æŸ¥æ‰¾ä¸‹ä¸€é¡µæŒ‰é’®
        function findNextPageButton() {
            // å¸¸è§çš„åˆ†é¡µæŒ‰é’®é€‰æ‹©å™¨
            const selectors = [
                'a.next',
                'a[rel="next"]',
                '.pagination a:contains("ä¸‹ä¸€é¡µ")',
                '.pagination a:contains("next")',
                '.pager a:contains("ä¸‹ä¸€é¡µ")'
            ];
            
            for (const selector of selectors) {
                const btn = document.querySelector(selector);
                if (btn && !btn.classList.contains('disabled')) {
                    return btn;
                }
            }
            
            // é€šè¿‡æ–‡æœ¬æŸ¥æ‰¾
            const links = document.querySelectorAll('a');
            for (const link of links) {
                const text = link.textContent.trim();
                if (text.includes('ä¸‹ä¸€é¡µ') || text.includes('next') || text.includes('Â»')) {
                    if (!link.classList.contains('disabled')) {
                        return link;
                    }
                }
            }
            
            return null;
        }
        
        // å¼€å§‹éå†
        async function startScraping() {
            if (isRunning) {
                log('éå†æ­£åœ¨è¿›è¡Œä¸­...', 'warning');
                return;
            }
            
            isRunning = true;
            startBtn.disabled = true;
            startBtn.textContent = 'éå†ä¸­...';
            
            log('å¼€å§‹éå†å·²è´­ä¹¦ç±...', 'info');
            
            try {
                // éå†å½“å‰é¡µ
                const books = await scrapePage();
                
                if (books.length > 0) {
                    // å»é‡å¹¶æ·»åŠ 
                    books.forEach(book => {
                        if (!collectedBooks.find(b => b.bookId === book.bookId)) {
                            collectedBooks.push(book);
                        }
                    });
                    
                    currentPage++;
                    pageCountEl.textContent = currentPage;
                    totalCountEl.textContent = collectedBooks.length;
                    
                    log(`ç¬¬ ${currentPage} é¡µï¼šæ”¶é›†åˆ° ${books.length} æœ¬ä¹¦ç±ï¼Œæ€»è®¡ ${collectedBooks.length} æœ¬`, 'success');
                    
                    // æŸ¥æ‰¾ä¸‹ä¸€é¡µæŒ‰é’®
                    const nextBtn = findNextPageButton();
                    if (nextBtn) {
                        log('æ‰¾åˆ°ä¸‹ä¸€é¡µæŒ‰é’®ï¼Œ3ç§’åè‡ªåŠ¨è·³è½¬...', 'info');
                        setTimeout(() => {
                            nextBtn.click();
                            // ç­‰å¾…é¡µé¢åŠ è½½åç»§ç»­
                            setTimeout(startScraping, 2000);
                        }, 3000);
                        return;
                    } else {
                        log('å·²åˆ°è¾¾æœ€åä¸€é¡µï¼', 'success');
                    }
                } else {
                    log('å½“å‰é¡µé¢æ²¡æœ‰æ‰¾åˆ°ä¹¦ç±', 'warning');
                }
                
                // éå†å®Œæˆ
                log(`éå†å®Œæˆï¼å…±æ”¶é›† ${collectedBooks.length} æœ¬ä¹¦ç±`, 'success');
                uploadBtn.disabled = collectedBooks.length === 0;
                progressBar.style.width = '100%';
                
            } catch (error) {
                log(`éå†å‡ºé”™: ${error.message}`, 'error');
            } finally {
                isRunning = false;
                startBtn.disabled = false;
                startBtn.textContent = 'é‡æ–°éå†';
            }
        }
        
        // æ‰¹é‡ä¸Šä¼ 
        async function uploadBooks() {
            if (collectedBooks.length === 0) {
                log('æ²¡æœ‰å¯ä¸Šä¼ çš„æ•°æ®', 'warning');
                return;
            }
            
            const apiUrl = apiUrlInput.value.trim();
            if (!apiUrl) {
                log('è¯·å¡«å†™APIåœ°å€', 'error');
                return;
            }
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';
            
            log(`å¼€å§‹ä¸Šä¼  ${collectedBooks.length} æœ¬ä¹¦ç±å…ƒä¿¡æ¯...`, 'info');
            
            try {
                const response = await fetch(`${apiUrl}/metadata/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // åŒ…å«cookie
                    body: JSON.stringify({ books: collectedBooks })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    log(`âœ“ ä¸Šä¼ æˆåŠŸï¼æˆåŠŸ: ${result.stats.success}, å¤±è´¥: ${result.stats.failed}`, 'success');
                    uploadCountEl.textContent = result.stats.success;
                    
                    if (result.stats.errors.length > 0) {
                        result.stats.errors.forEach(err => {
                            log(`é”™è¯¯: ${err}`, 'error');
                        });
                    }
                } else {
                    log(`ä¸Šä¼ å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
                
            } catch (error) {
                log(`âœ— ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'æ‰¹é‡ä¸Šä¼ ';
            }
        }
        
        // æ¸…ç©ºæ•°æ®
        function clearData() {
            if (collectedBooks.length === 0 || confirm('ç¡®å®šè¦æ¸…ç©ºå·²æ”¶é›†çš„æ•°æ®å—ï¼Ÿ')) {
                collectedBooks = [];
                currentPage = 1;
                totalCountEl.textContent = '0';
                pageCountEl.textContent = '0';
                uploadCountEl.textContent = '0';
                progressBar.style.width = '0%';
                uploadBtn.disabled = true;
                log('å·²æ¸…ç©ºæ•°æ®', 'info');
            }
        }
        
        // äº‹ä»¶ç»‘å®š
        startBtn.addEventListener('click', startScraping);
        uploadBtn.addEventListener('click', uploadBooks);
        clearBtn.addEventListener('click', clearData);
        
        // è‡ªåŠ¨æ£€æµ‹å·²è´­ä¹¦æ¶é¡µé¢
        if (window.location.href.includes('po18.tw')) {
            log('æ£€æµ‹åˆ°PO18ç½‘ç«™ï¼Œå‡†å¤‡å°±ç»ª', 'success');
        } else {
            log('âš  è­¦å‘Šï¼šè¯·åœ¨PO18å·²è´­ä¹¦æ¶é¡µé¢æ‰“å¼€æ­¤å·¥å…·', 'warning');
        }
    </script>
</body>
</html>
