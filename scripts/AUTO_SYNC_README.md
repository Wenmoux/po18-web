# PO18书籍元信息自动同步油猴脚本

## 📖 功能说明

这是一个Tampermonkey（油猴）脚本，可以在浏览器中自动遍历PO18网站的**搜索/找书页面**，收集书籍元信息并上传到本地数据库。

**主要优势**：
- ✅ 利用浏览器环境自动获取Cookie和CSRF Token
- ✅ 自动翻页遍历所有搜索结果
- ✅ 支持批量收集后一次性上传
- ✅ 实时显示进度和统计
- ✅ 美观的可视化界面
- ✅ 支持多种页面：搜索、分类、标签、书籍列表

## 🚀 安装方法

### 1. 安装Tampermonkey扩展

根据您的浏览器选择：

- **Chrome/Edge**: [Tampermonkey](https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo)
- **Firefox**: [Tampermonkey](https://addons.mozilla.org/zh-CN/firefox/addon/tampermonkey/)
- **Safari**: [Tampermonkey](https://apps.apple.com/cn/app/tampermonkey/id1482490089)

### 2. 安装脚本

1. 点击Tampermonkey图标
2. 选择"创建新脚本"
3. 将 `po18-auto-sync.user.js` 的内容复制粘贴进去
4. 按 `Ctrl+S` 保存

或者：

1. 直接双击 `po18-auto-sync.user.js` 文件
2. Tampermonkey会自动打开安装页面
3. 点击"安装"按钮

## 🎯 使用方法

### 方式一：搜索/找书页面批量同步（推荐）

1. **启动本地服务器**
   ```bash
   cd e:\Users\Administrator\Desktop\game2\po18-web
   npm start
   ```

2. **登录PO18网站**
   - 访问 https://www.po18.tw
   - 登录您的账号

3. **进入搜索/找书页面**
   - 使用搜索功能：https://www.po18.tw/search?q=关键词
   - 或浏览分类：https://www.po18.tw/category/分类名
   - 或浏览标签：https://www.po18.tw/tags/标签名
   - 或任何书籍列表页面

4. **打开同步面板**
   - 点击右上角的"📚 元信息同步"按钮
   - 面板会展开显示

5. **配置API地址**（首次使用）
   - 确认API地址为：`http://localhost:3000`
   - 如果服务器运行在其他端口，请修改

6. **开始同步**
   - 点击"开始同步"按钮
   - 脚本会自动：
     - 解析当前页面的所有书籍
     - 自动跳转到下一页
     - 重复直到遍历完所有页面

7. **批量上传**
   - 遍历完成后，点击"批量上传"按钮
   - 所有收集的书籍信息会一次性上传到数据库

### 方式二：单本书籍同步

1. **访问书籍详情页**
   - 例如：https://www.po18.tw/books/123456/articles

2. **打开同步面板**
   - 点击"📚 元信息同步"按钮

3. **开始同步**
   - 点击"开始同步"
   - 当前书籍信息会被解析并添加到队列

4. **上传数据**
   - 点击"批量上传"提交到数据库

## 📊 界面说明

### 统计信息

- **已收集**: 已解析的书籍数量
- **已上传**: 成功上传到数据库的数量
- **失败**: 上传失败的数量
- **当前页**: 当前正在处理的页码

### 按钮功能

- **开始同步**: 开始遍历和收集书籍信息
- **批量上传**: 将收集的数据上传到数据库
- **清空数据**: 清除已收集的数据（不影响已上传的）

### 日志窗口

实时显示：
- 🟢 成功操作
- 🔴 错误信息
- ⚪ 一般信息

## ⚙️ 配置选项

### 修改配置

在脚本中找到 `CONFIG` 对象：

```javascript
const CONFIG = {
    apiUrl: 'http://localhost:3000',  // API地址
    autoSync: false,                   // 是否自动开始同步
    syncOnLoad: true,                  // 页面加载时同步
    batchMode: true,                   // 批量模式
    delay: 1000,                       // 翻页延迟（毫秒）
    maxRetries: 3                      // 最大重试次数
};
```

### 配置说明

- **apiUrl**: 本地API服务器地址
- **autoSync**: 启用后，进入已购书架页面会自动开始同步
- **batchMode**: 批量模式，收集完所有数据后一次性上传
- **delay**: 自动翻页的延迟时间，避免请求过快
- **maxRetries**: 上传失败时的重试次数

## 🔧 工作原理

### 数据流程

```
PO18网站页面
    ↓ (解析HTML)
浏览器收集书籍信息
    ↓ (批量收集)
本地数组缓存
    ↓ (点击上传)
POST /metadata/batch
    ↓ (保存)
本地SQLite数据库
```

### 解析策略

脚本会尝试从页面中提取：

**从书籍详情页**：
- 书籍ID（从URL）
- 书名（h1标题）
- 作者（作者链接）
- 封面（封面图片）
- 简介（简介文本）
- 标签（标签列表）
- 章节数（章节列表长度）
- 字数（字数信息）

**从已购书架页**：
- 书籍ID（从链接）
- 书名（标题元素）
- 作者（作者信息）
- 封面（缩略图）
- 标签（标签列表）

### 自动翻页

1. 解析当前页面的书籍
2. 检测是否有下一页
3. 延迟后自动跳转
4. 重复1-3直到最后一页

## 📝 注意事项

### 1. Cookie有效性

- ⚠️ 脚本运行时必须保持登录状态
- ⚠️ Cookie过期会导致无法获取书籍信息
- ⚠️ 建议在登录后立即运行

### 2. 服务器状态

- ⚠️ 确保本地服务器已启动（`npm start`）
- ⚠️ 检查服务器运行在正确的端口（默认3000）
- ⚠️ 防火墙可能阻止localhost连接

### 3. 页面结构变化

- ⚠️ 如果PO18网站更新了页面结构，可能需要调整选择器
- ⚠️ 脚本中的CSS选择器基于当前页面结构
- ⚠️ 可以在浏览器控制台查看解析结果

### 4. 数据去重

- ✅ 脚本会自动去重，相同bookId的书籍只收集一次
- ✅ 数据库中已存在的书籍会被更新而不是重复插入

### 5. 网络延迟

- ⚠️ 翻页延迟默认1秒，可以根据网络情况调整
- ⚠️ 延迟太短可能被网站限制
- ⚠️ 延迟太长会导致遍历时间过长

## 🛠️ 自定义选择器

如果脚本无法正确解析书籍信息，您可以修改CSS选择器：

### 书籍详情页选择器

```javascript
// 书名
const titleEl = document.querySelector('h1.book-title, h1, .book-name');

// 作者
const authorEl = document.querySelector('.author-name, .book-author, a[href*="/users/"]');

// 封面
const coverEl = document.querySelector('.book-cover img, .cover img, img[src*="cover"]');
```

### 已购书架页选择器

```javascript
// 书籍列表容器
const bookElements = document.querySelectorAll('.book-item, .book, li[class*="book"], .mybook-item');

// 书籍链接
const link = el.querySelector('a[href*="/books/"]');

// 书名
const titleEl = el.querySelector('.book-title, .title, h3, h4');
```

**修改步骤**：
1. 打开浏览器开发者工具（F12）
2. 检查页面元素，找到正确的类名或选择器
3. 在脚本中修改对应的选择器
4. 保存脚本并刷新页面

## 🔍 故障排除

### 问题1: 无法上传数据

**症状**: 点击"批量上传"后显示网络错误

**解决**:
1. 检查本地服务器是否运行：浏览器访问 `http://localhost:3000`
2. 检查API地址配置是否正确
3. 查看浏览器控制台的错误信息
4. 检查Tampermonkey的连接权限设置

### 问题2: 无法解析书籍信息

**症状**: 收集数量为0或信息不完整

**解决**:
1. 打开浏览器控制台（F12）
2. 查看是否有JavaScript错误
3. 检查页面HTML结构是否变化
4. 根据实际页面调整CSS选择器

### 问题3: 自动翻页失败

**症状**: 遍历停在第一页

**解决**:
1. 检查分页按钮的选择器
2. 查看控制台日志
3. 手动点击下一页，观察URL变化
4. 根据实际情况调整翻页逻辑

### 问题4: 数据重复

**症状**: 同一本书被收集多次

**解决**:
- 脚本内置了去重机制，基于bookId
- 如果仍然重复，检查bookId提取逻辑
- 清空数据后重新收集

## 💡 最佳实践

### 1. 首次使用

```
1. 小范围测试（1-2页）
2. 检查数据是否正确
3. 确认上传成功
4. 再进行大规模同步
```

### 2. 定期更新

```
1. 每周或每月运行一次
2. 更新新购买的书籍
3. 补充缺失的书籍信息
```

### 3. 数据备份

```
1. 同步前备份数据库
2. 避免数据丢失
3. 可以恢复到之前状态
```

### 4. 性能优化

```
1. 避开高峰期运行
2. 适当增加延迟
3. 分批次处理大量数据
```

## 📊 数据统计

同步完成后，您可以：

1. **在管理后台查看统计**
   - 访问 `http://localhost:3000/admin.html`
   - 查看书籍元信息总数

2. **在搜索页面使用**
   - 搜索已同步的书籍
   - 查看详细信息
   - 下载书籍内容

3. **导出数据**
   - 通过数据库工具导出
   - 备份或分析数据

## 🤝 反馈

如有问题或建议，请随时联系！

---

**版本**: 1.0.0  
**作者**: Your Name  
**更新日期**: 2024-12-14
