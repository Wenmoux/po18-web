<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        />
        <title>荼蘼辞</title>

        <!-- 性能优化：预加载CSS -->
        <link rel="preload" href="css/style.css?v=20251224e" as="style" />
        <link rel="preload" href="css/components.css?v=20251224e" as="style" />

        <!-- DNS预解析 -->
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
        <link rel="dns-prefetch" href="https://www.po18.tw" />
        <link rel="dns-prefetch" href="https://www.popo.tw" />
        <link rel="dns-prefetch" href="https://unpkg.com" />
        <link rel="preconnect" href="https://unpkg.com" crossorigin />

        <!-- PWA支持 -->
        <link rel="manifest" href="/manifest.json" />
        <meta name="theme-color" content="#D81B60" />
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="apple-mobile-web-app-title" content="荼蘼辞">
        <link rel="apple-touch-icon" href="/icons/icon.svg" />

        <!-- 关键CSSS内联 -->
        <style>
            /* 首屏关键CCS */
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                background: #fafafa;
                color: #333;
                line-height: 1.6;
            }
            .loading { opacity: 0; }
            .loaded { opacity: 1; transition: opacity 0.3s ease; }
            .skeleton { 
                background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                background-size: 200% 100%;
                animation: skeleton-loading 1.5s ease-in-out infinite;
                border-radius: 8px;
            }
            @keyframes skeleton-loading {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }
            .skeleton-card { height: 120px; margin-bottom: 16px; }
            #app { min-height: 100vh; }
            /* 强制隐藏旧书架容器 */
            #bookshelf-list {
                display: none !important;
                visibility: hidden !important;
                position: absolute !important;
                left: -9999px !important;
                opacity: 0 !important;
                pointer-events: none !important;
                height: 0 !important;
                overflow: hidden !important;
            }
            /* 确保智能书架容器显示 */
            #bookshelf-container {
                display: block !important;
            }
        </style>

        <link rel="stylesheet" href="css/style.css?v=20251224e" />
        <link rel="stylesheet" href="css/bookshelf.css?v=20251224e" />
        <link rel="stylesheet" href="css/components.css?v=20251224e" />
        <link rel="stylesheet" href="css/mobile-enhancements.css?v=20251224e" />

        <!-- 字体异步加载 -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600&display=swap"
            rel="stylesheet"
            media="print"
            onload="this.media = 'all'"
        />
        <noscript>
            <link
                href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600&display=swap"
                rel="stylesheet"
            />
        </noscript>
    </head>
    <body>
        <div id="app">
            <!-- 顶部导航 - MD3风格 -->
            <header class="header">
                <div class="logo">
                    <span class="logo-icon">🌸</span>
                    <span class="logo-text">荼蘼辞</span>
                </div>
                <nav class="nav" id="main-nav">
                    <a href="#" class="nav-link active" data-page="download">🌸 春尽阁</a>
                    <a href="#" class="nav-link" data-page="rankings">🏆 花事了</a>
                    <a href="#" class="nav-link" data-page="bookshelf">📖 芸香屉</a>
                    <a href="#" class="nav-link" data-page="book-lists">📑 花间集</a>
                    <a href="#" class="nav-link" data-page="global-library" id="nav-global-library" style="display: none">🌎 琅嬛录</a>
                    <a href="#" class="nav-link" data-page="subscriptions" id="nav-subscriptions">
                        🔔 青鸟约
                        <span class="nav-badge" id="subscription-badge" style="display: none">0</span>
                    </a>
                    <a href="#" class="nav-link" data-page="settings">👤 镜里妆</a>
                </nav>
                <div class="user-area" id="user-area">
                    <button class="btn btn-primary" id="btn-login">登录</button>
                    <button class="btn btn-outline" id="btn-register">注册</button>
                </div>
                <div class="user-info" id="user-info" style="display: none">
                    <a href="/admin.html" id="admin-link" class="btn btn-sm btn-tonal" style="display: none">📊 管理</a>
                    <button class="theme-toggle" id="theme-toggle" title="切换主题">🌙</button>
                    <button class="btn btn-sm btn-outline" id="btn-logout">登出</button>
                </div>
            </header>

            <!-- 主内容区 -->
            <main class="main-content">
                <!-- 首页 -->
                <section class="page active" id="page-download">
                    <!-- 搜索区域 -->
                    <div class="hero-search-card">
                        <div class="search-header">
                            <h2 style="font-size: 20px; font-weight: 600; margin: 0; color: var(--md-primary);">
                                🔍 觅檀痕
                            </h2>
                            <p style="font-size: 13px; color: var(--md-on-surface-variant); margin: 4px 0 0 0;">
                                支持书名、ID、链接搜索
                            </p>
                        </div>
                        <div class="search-form">
                            <div class="search-input-wrapper">
                                <span class="input-icon">📚</span>
                                <input
                                    type="text"
                                    id="unified-input"
                                    class="search-input"
                                    placeholder="输入书籍 ID、链接或书名搜索..."
                                />
                            </div>
                            <div class="search-actions">
                                <div class="format-selector">
                                    <select id="quick-download-format" class="format-select">
                                        <option value="txt">📄 TXT</option>
                                        <option value="epub">📖 EPUB</option>
                                    </select>
                                </div>
                                <div class="action-buttons">
                                    <button class="action-btn action-btn-outline" id="parse-book-btn">
                                        <span class="btn-icon">⚙️</span>
                                        <span class="btn-text">解析</span>
                                    </button>
                                    <button class="action-btn action-btn-primary" id="quick-download-btn">
                                        <span class="btn-icon">⬇️</span>
                                        <span class="btn-text">下载</span>
                                    </button>
                                    <button class="action-btn action-btn-accent" id="search-btn">
                                        <span class="btn-icon">🔍</span>
                                        <span class="btn-text">搜索</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="parsed-book-info" class="parsed-info"></div>
                    </div>

                    <!-- 快捷功能区域 -->
                    <div class="quick-access-section" style="margin-bottom: 20px;">
                        <div class="section-header">
                            <h3 class="section-title">
                                <span class="section-icon">⚡</span>
                                快捷功能
                            </h3>
                        </div>
                        <div class="quick-access-grid">
                            <div class="quick-access-card" onclick="App.navigateTo('rankings')">
                                <div class="access-icon">🏆</div>
                                <div class="access-title">花事了</div>
                                <div class="access-desc">热门书籍推荐</div>
                            </div>
                            <div class="quick-access-card" onclick="App.navigateTo('bookshelf')">
                                <div class="access-icon">📚</div>
                                <div class="access-title">芸香屉</div>
                                <div class="access-desc">继续阅读</div>
                            </div>
                            <div class="quick-access-card" onclick="App.navigateTo('book-lists')">
                                <div class="access-icon">📑</div>
                                <div class="access-title">花间集</div>
                                <div class="access-desc">发现好书</div>
                            </div>
                            <div class="quick-access-card" onclick="App.navigateTo('library')">
                                <div class="access-icon">📖</div>
                                <div class="access-title">琅嬛录</div>
                                <div class="access-desc">管理我的书籍</div>
                            </div>
                            <div class="quick-access-card" onclick="App.navigateTo('downloads')">
                                <div class="access-icon">📥</div>
                                <div class="access-title">云篆集</div>
                                <div class="access-desc">查看下载记录</div>
                            </div>
                            <div class="quick-access-card" onclick="App.navigateTo('subscriptions')">
                                <div class="access-icon">🔔</div>
                                <div class="access-title">青鸟约</div>
                                <div class="access-desc">书籍更新提醒</div>
                            </div>
                        </div>
                    </div>

                    <!-- 继续阅读卡片区域 -->
                    <div class="continue-reading-section" id="continue-reading-section" style="margin-top: 20px">
                        <div class="section-header">
                            <h3 class="section-title">
                                <span class="section-icon">📖</span>
                                继续阅读
                            </h3>
                            <a href="#bookshelf" class="section-link">查看全部 ›</a>
                        </div>
                        <div class="continue-reading-cards" id="continue-reading-cards">
                            <!-- 卡片将通过JS动态生成 -->
                            <p
                                class="empty-message"
                                style="
                                    width: 100%;
                                    text-align: center;
                                    color: var(--md-on-surface-variant);
                                    padding: 20px;
                                "
                            >
                                加载中...
                            </p>
                        </div>
                    </div>

                    <!-- 搜索结果 -->
                    <div class="search-results" id="search-results" style="margin-top: 16px">
                        <p class="empty-message">输入关键词搜索已收录的书籍，或输入ID/链接直接下载</p>
                    </div>

                    <!-- 热门书籍推荐 -->
                    <div class="popular-books-section" style="margin-top: 20px">
                        <div class="section-header">
                            <h3 class="section-title">
                                <span class="section-icon">🔥</span>
                                热门推荐
                            </h3>
                            <a href="#rankings" class="section-link">查看更多 ›</a>
                        </div>
                        <div class="popular-books-grid" id="popular-books-grid">
                            <div class="skeleton-card"></div>
                            <div class="skeleton-card"></div>
                            <div class="skeleton-card"></div>
                            <div class="skeleton-card"></div>
                            <div class="skeleton-card"></div>
                            <div class="skeleton-card"></div>
                            <div class="skeleton-card"></div>
                            <div class="skeleton-card"></div>
                            <div class="skeleton-card"></div>
                        </div>
                    </div>

                    <!-- 最近更新书籍 -->
                    <div class="recent-books-section" style="margin-top: 20px">
                        <div class="section-header">
                            <h3 class="section-title">
                                <span class="section-icon">🆕</span>
                                最近更新
                            </h3>
                            <a href="#rankings" class="section-link">查看更多 ›</a>
                        </div>
                        <div class="recent-books-list" id="recent-books-list">
                            <div class="skeleton-row"></div>
                            <div class="skeleton-row"></div>
                            <div class="skeleton-row"></div>
                            <div class="skeleton-row"></div>
                            <div class="skeleton-row"></div>
                            <div class="skeleton-row"></div>
                        </div>
                    </div>

                    <!-- 共享书库部分 -->
                    <div id="shared-section" style="margin-top: 24px">
                        <div class="section-header" style="margin-bottom: 16px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin: 0; color: var(--md-on-surface);">
                                📚 绿肥红瘦
                            </h3>
                            <p style="font-size: 13px; color: var(--md-on-surface-variant); margin: 4px 0 0 0;">
                                浏览和下载其他用户分享的书籍
                            </p>
                        </div>
                        <div class="share-info" id="share-info">
                            <div class="share-notice md-card">
                                <div class="notice-icon">📚</div>
                                <div class="notice-content">
                                    <h3>共享书库规则</h3>
                                    <ul>
                                        <li>启用共享后，可将书库中的书籍分享给其他用户</li>
                                        <li>
                                            上传至少
                                            <strong>3本书籍</strong>
                                            后，即可访问完整共享书库
                                        </li>
                                        <li>共享的书籍将自动上传至公共WebDAV服务器</li>
                                    </ul>
                                    <button class="btn btn-primary" id="enable-share-btn">启用共享</button>
                                </div>
                            </div>
                        </div>
                        <div class="share-search" id="share-search" style="display: none">
                            <input type="text" id="share-search-input" class="md-input" placeholder="搜索共享书库..." />
                            <button class="btn btn-primary" id="share-search-btn">搜索</button>
                        </div>
                        <!-- 共享书库筛选器 -->
                        <div class="filter-bar" id="shared-filter-bar" style="display: none">
                            <select id="shared-category-filter" class="md-select">
                                <option value="">所有分类</option>
                                <option value="高H">高H</option>
                                <option value="1V1">1V1</option>
                                <option value="HNP">HNP</option>
                                <option value="BG">BG</option>
                                <option value="BL">BL</option>
                                <option value="骨科">骨科</option>
                                <option value="古代">古代</option>
                                <option value="現代">現代</option>
                                <option value="穿越">穿越</option>
                                <option value="重生">重生</option>
                                <option value="甜文">甜文</option>
                                <option value="耕美">耕美</option>
                                <option value="百合">百合</option>
                            </select>
                            <select id="shared-format-filter" class="md-select">
                                <option value="">所有格式</option>
                            </select>
                            <button class="btn btn-outline" id="shared-clear-filter">清除筛选</button>
                        </div>
                        <div class="shared-list" id="shared-list"></div>
                    </div>
                </section>

                <!-- 排行榜页 -->
                <section class="page" id="page-rankings">
                    <div class="page-header">
                        <p class="page-subtitle">每6小时自动更新</p>
                    </div>

                    <div class="rankings-tabs">
                        <button class="ranking-tab active" data-type="favorites">收藏榜</button>
                        <button class="ranking-tab" data-type="comments">留言榜</button>
                        <button class="ranking-tab" data-type="monthly">月人气</button>
                        <button class="ranking-tab" data-type="total">总人气</button>
                        <button class="ranking-tab" data-type="wordcount">字数榜</button>
                        <button class="ranking-tab" data-type="latest">最近更新</button>
                    </div>

                    <div class="ranking-list" id="ranking-list">
                        <p class="empty-message">加载中...</p>
                    </div>
                </section>

                <!-- 已购书籍页 -->
                <section class="page" id="page-purchased">
                    <div class="page-header">
                        <h2>📚 知否知否</h2>
                        <p class="page-subtitle">查看您已购买的书籍</p>
                    </div>
                    <div class="page-header">
                        <button class="btn btn-outline" id="refresh-purchased">刷新</button>
                    </div>
                    <div class="login-required" id="purchased-login-required">
                        <p>请先登录并设置PO18 Cookie</p>
                        <button class="btn btn-primary" id="purchased-login-btn">登录</button>
                    </div>
                    <div class="book-list" id="purchased-list"></div>
                </section>

                <!-- 下载管理页（单列表显示） -->
                <section class="page" id="page-downloads">
                    <div class="page-header">
                        <h2>📥 云篆集</h2>
                        <p class="page-subtitle">管理您的下载任务</p>
                    </div>
                    <div class="page-header">
                        <button class="btn btn-outline" id="clear-completed">清除已完成</button>
                    </div>

                    <!-- 统一下载列表 -->
                    <div class="download-list" id="download-list">
                        <p class="empty-message">暂无下载记录</p>
                    </div>
                </section>

                <!-- 我的书架页 -->
                <section class="page" id="page-bookshelf">
                    <div class="page-header">
                        <h2>📖 芸香屉</h2>
                        <p class="page-subtitle">记录你的阅读历程</p>
                    </div>

                    <!-- 筛选和排序 - 已隐藏，使用智能书架的标签筛选器 -->
                    <div class="filter-bar" style="display: none !important; visibility: hidden !important;">
                        <select id="bookshelf-sort-select" class="md-select">
                            <option value="recent">最近阅读</option>
                            <option value="progress">阅读进度</option>
                            <option value="time">阅读时长</option>
                            <option value="added">添加时间</option>
                        </select>
                    </div>

                    <!-- 智能书架容器 -->
                    <div id="bookshelf-container">
                        <!-- 标签筛选器 -->
                        <div class="tag-filters" id="tag-filters-container"></div>

                        <!-- 批量操作栏 -->
                        <div class="bookshelf-batch-actions" id="bookshelf-batch-actions" style="display: none;">
                            <div class="batch-info">
                                <span>已选择 <span id="batch-count">0</span> 本书</span>
                            </div>
                            <div class="batch-controls">
                                <select id="batch-tag-select" class="md-select">
                                    <option value="">选择标签</option>
                                </select>
                                <button class="btn btn-sm btn-primary" id="batch-apply-tag">应用标签</button>
                                <button class="btn btn-sm btn-outline" id="batch-mark-read">标记已读</button>
                                <button class="btn btn-sm btn-outline" id="batch-mark-unread">标记未读</button>
                                <button class="btn btn-sm btn-outline" id="batch-cancel">取消</button>
                            </div>
                        </div>

                        <!-- 批量操作按钮 -->
                        <div class="bookshelf-toolbar">
                            <button class="btn btn-outline btn-sm" id="bookshelf-batch-mode">批量操作</button>
                        </div>

                        <!-- 书架列表（智能分组） -->
                        <div class="bookshelf-groups">
                            <div id="bookshelf-group-reading" class="bookshelf-group" style="display: none;">
                                <h3 class="group-title">📖 阅读中</h3>
                                <div class="bookshelf-list" id="bookshelf-list-reading"></div>
                            </div>
                            <div id="bookshelf-group-to-read" class="bookshelf-group" style="display: none;">
                                <h3 class="group-title">📚 待读</h3>
                                <div class="bookshelf-list" id="bookshelf-list-to-read"></div>
                            </div>
                            <div id="bookshelf-group-finished" class="bookshelf-group" style="display: none;">
                                <h3 class="group-title">✅ 已读完</h3>
                                <div class="bookshelf-list" id="bookshelf-list-finished"></div>
                            </div>
                            <div id="bookshelf-group-dropped" class="bookshelf-group" style="display: none;">
                                <h3 class="group-title">🗑️ 已弃</h3>
                                <div class="bookshelf-list" id="bookshelf-list-dropped"></div>
                            </div>
                            <div id="bookshelf-group-default" class="bookshelf-group" style="display: none;">
                                <h3 class="group-title">📦 未分类</h3>
                                <div class="bookshelf-list" id="bookshelf-list-default"></div>
                            </div>
                        </div>

                        <!-- 空状态 -->
                        <div id="bookshelf-empty" class="empty-message" style="display: none;">
                            <p>书架空空如也，快去添加你喜欢的书籍吧</p>
                        </div>

                        <!-- 兼容旧版：保留原有列表容器（默认隐藏） -->
                        <div class="bookshelf-list" id="bookshelf-list" style="display: none !important; visibility: hidden !important; position: absolute !important; left: -9999px !important; opacity: 0 !important; pointer-events: none !important;">
                            <p class="empty-message">书架空空如也，快去添加你喜欢的书籍吧</p>
                        </div>
                    </div>
                </section>

                <!-- 我的书库页 -->
                <section class="page" id="page-library">
                    <div class="page-header">
                        <p class="page-subtitle">管理您下载的书籍</p>
                    </div>

                    <!-- 书库统计 -->
                    <div
                        class="stats-summary"
                        id="library-stats"
                        style="
                            margin-bottom: 20px;
                            padding: 15px;
                            background: rgba(var(--md-surface-container-lowest-rgb, 255, 251, 255), 0.8);
                            border-radius: var(--md-radius-lg);
                            text-align: center;
                        "
                    >
                        <span>
                            总书籍数:
                            <strong id="library-total-count">0</strong>
                            本
                        </span>
                    </div>

                    <!-- 筛选器 -->
                    <div class="filter-bar" id="library-filter-bar">
                        <select id="library-category-filter" class="md-select">
                            <option value="">所有分类</option>
                            <option value="高H">高H</option>
                            <option value="1V1">1V1</option>
                            <option value="HNP">HNP</option>
                            <option value="BG">BG</option>
                            <option value="BL">BL</option>
                            <option value="骨科">骨科</option>
                            <option value="古代">古代</option>
                            <option value="現代">現代</option>
                            <option value="穿越">穿越</option>
                            <option value="重生">重生</option>
                            <option value="甜文">甜文</option>
                        </select>
                        <select id="library-author-filter" class="md-select">
                            <option value="">所有作者</option>
                        </select>
                        <select id="library-format-filter" class="md-select">
                            <option value="">所有格式</option>
                        </select>
                        <button class="btn btn-outline" id="library-clear-filter">清除筛选</button>
                    </div>
                    <div class="library-list" id="library-list">
                        <p class="empty-message">书库为空，去下载一些小说吧</p>
                    </div>
                </section>

                <!-- 全站书库页（仅授权用户） -->
                <section class="page" id="page-global-library">
                    <div class="page-header">
                        <h2>🌐 琅嬛录</h2>
                        <p class="page-subtitle">浏览所有包含正文内容的书籍</p>
                    </div>

                    <!-- 数量统计 -->
                    <div
                        class="stats-bar"
                        id="global-library-stats"
                        style="
                            display: flex;
                            gap: 20px;
                            margin-bottom: 20px;
                            padding: 15px;
                            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
                            border-radius: 12px;
                            color: white;
                            box-shadow: 0 4px 15px rgba(196, 69, 105, 0.3);
                        "
                    >
                        <div class="stat-item" style="text-align: center; flex: 1">
                            <div class="stat-value" id="global-total-books" style="font-size: 24px; font-weight: bold">
                                0
                            </div>
                            <div class="stat-label" style="font-size: 12px; opacity: 0.9">总书籍</div>
                        </div>
                        <div class="stat-item" style="text-align: center; flex: 1">
                            <div
                                class="stat-value"
                                id="global-total-chapters"
                                style="font-size: 24px; font-weight: bold"
                            >
                                0
                            </div>
                            <div class="stat-label" style="font-size: 12px; opacity: 0.9">总章节</div>
                        </div>
                        <div class="stat-item" style="text-align: center; flex: 1">
                            <div
                                class="stat-value"
                                id="global-filtered-count"
                                style="font-size: 24px; font-weight: bold"
                            >
                                0
                            </div>
                            <div class="stat-label" style="font-size: 12px; opacity: 0.9">当前显示</div>
                        </div>
                    </div>

                    <!-- 筛选和排序 -->
                    <div class="filter-bar">
                        <div class="filter-group">
                            <select id="global-tag-filter" class="md-select">
                                <option value="">所有标签</option>
                            </select>
                            <select id="global-sort" class="md-select">
                                <option value="latest">最新更新</option>
                                <option value="favorites">收藏排行</option>
                                <option value="comments">留言排行</option>
                                <option value="wordcount">字数排行</option>
                                <option value="cached">缓存章节</option>
                            </select>
                            <div class="input-group" style="max-width: 200px">
                                <input type="number" id="global-min-words" class="md-input" placeholder="最少字数" />
                            </div>
                            <div class="input-group" style="max-width: 200px">
                                <input type="number" id="global-max-words" class="md-input" placeholder="最多字数" />
                            </div>
                            <button class="btn btn-primary" id="global-filter-btn">筛选</button>
                            <button class="btn btn-outline" id="global-reset-btn">重置</button>
                        </div>
                    </div>

                    <div class="book-list" id="global-library-list">
         
                    </div>
                </section>

                <!-- 订阅管理页面 -->
                <section class="page" id="page-subscriptions">
                    <div class="page-header">
                        <h2>🔔 青鸟约</h2>
                        <p class="page-subtitle">关注的书籍有更新时会及时通知你</p>
                    </div>

                    <!-- 更新提醒标签页 -->
                    <div class="subscription-tabs" style="margin-bottom: 20px">
                        <button class="sub-tab active" data-filter="all">
                            全部订阅 (
                            <span id="sub-count-all">0</span>
                            )
                        </button>
                        <button class="sub-tab" data-filter="updated">
                            有更新 (
                            <span id="sub-count-updated">0</span>
                            )
                        </button>
                    </div>

                    <!-- 浏览器通知设置 -->
                    <div
                        class="notification-setting glass-card"
                        id="notification-setting"
                        style="margin-bottom: 20px; padding: 16px"
                    >
                        <div style="display: flex; align-items: center; justify-content: space-between">
                            <div>
                                <div style="font-weight: 600">🔔 浏览器通知</div>
                                <div style="font-size: 12px; color: #666">开启后，订阅的书籍更新时会推送通知</div>
                            </div>
                            <button class="btn btn-sm btn-outline" id="btn-enable-notification">开启通知</button>
                        </div>
                    </div>

                    <!-- 订阅列表 -->
                    <div class="subscription-list" id="subscription-list">
                        <p class="empty-message">暂无订阅，去书籍详情页点击"订阅更新"关注你喜欢的书籍吧</p>
                    </div>
                </section>

                <!-- 我的页面 -->
                <section class="page" id="page-settings">
                    <!-- 用户头部卡片 -->
                    <div class="profile-header-card">
                        <div class="profile-bg-pattern"></div>
                        <div class="profile-content">
                            <div class="profile-avatar">
                                <div class="avatar-ring"></div>
                                <div class="avatar-inner" id="user-avatar">
                                    <span class="avatar-text">📚</span>
                                </div>
                                <div class="avatar-badge">VIP</div>
                            </div>
                            <div class="profile-info">
                                <h2 class="profile-name" id="profile-username">加载中...</h2>
                                <p class="profile-bio">热爱阅读的书虫 📖</p>
                                <div class="profile-tags">
                                    <span class="tag tag-primary" id="user-level-tag">Lv.1 新手</span>
                                    <span class="tag tag-accent" id="user-days-tag">注册 0 天</span>
                                </div>
                            </div>
                            <div class="profile-actions">
                                <button class="profile-btn" id="edit-profile-btn">
                                    <span class="btn-icon">✏️</span>
                                    <span class="btn-text">编辑资料</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 阅读统计热力图 -->
                    <div class="reading-heatmap-section glass-card" style="margin-bottom: 12px; border-radius: 10px">
                        <div
                            class="section-header"
                            style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 10px;
                            "
                        >
                            <h3 style="margin: 0; font-size: 14px">📅 阅读统计</h3>
                            <div
                                class="heatmap-legend"
                                style="display: flex; align-items: center; gap: 5px; font-size: 10px; color: #666"
                            >
                                <span>少</span>
                                <div class="legend-colors" style="display: flex; gap: 2px">
                                    <div
                                        style="width: 8px; height: 8px; background: #ebedf0; border-radius: 1.5px"
                                    ></div>
                                    <div
                                        style="width: 8px; height: 8px; background: #fce4ec; border-radius: 1.5px"
                                    ></div>
                                    <div
                                        style="width: 8px; height: 8px; background: #f8bbd9; border-radius: 1.5px"
                                    ></div>
                                    <div
                                        style="width: 8px; height: 8px; background: #f48fb1; border-radius: 1.5px"
                                    ></div>
                                    <div
                                        style="width: 8px; height: 8px; background: #e91e63; border-radius: 1.5px"
                                    ></div>
                                </div>
                                <span>多</span>
                            </div>
                        </div>

                        <!-- 热力图容器 -->
                        <div class="heatmap-container" id="reading-heatmap" style="overflow-x: auto; margin-bottom: 10px">
                            <div class="heatmap-loading" style="text-align: center; padding: 20px; color: #999">
                                加载中...
                            </div>
                        </div>

                        <!-- 统计摘要 -->
                        <div
                            class="heatmap-summary"
                            style="
                                display: flex;
                                gap: 10px;
                                padding-top: 10px;
                                border-top: 1px solid #eee;
                                flex-wrap: wrap;
                            "
                        >
                            <div class="summary-item" style="flex: 1; min-width: 55px">
                                <span
                                    class="summary-value"
                                    id="total-reading-days"
                                    style="font-size: 14px; font-weight: 600; color: #e91e63"
                                >
                                    0
                                </span>
                                <span class="summary-label" style="font-size: 10px; color: #666; margin-left: 2px">
                                    天
                                </span>
                            </div>
                            <div class="summary-item" style="flex: 1; min-width: 65px">
                                <span
                                    class="summary-value"
                                    id="total-reading-minutes"
                                    style="font-size: 14px; font-weight: 600; color: #e91e63"
                                >
                                    0
                                </span>
                                <span class="summary-label" style="font-size: 10px; color: #666; margin-left: 2px">
                                    分钟
                                </span>
                            </div>
                            <div class="summary-item" style="flex: 1; min-width: 65px">
                                <span
                                    class="summary-value"
                                    id="current-streak"
                                    style="font-size: 14px; font-weight: 600; color: #e91e63"
                                >
                                    0
                                </span>
                                <span class="summary-label" style="font-size: 10px; color: #666; margin-left: 2px">
                                    连续
                                </span>
                            </div>
                            <div class="summary-item" style="flex: 1; min-width: 65px">
                                <span
                                    class="summary-value"
                                    id="longest-streak"
                                    style="font-size: 14px; font-weight: 600; color: #e91e63"
                                >
                                    0
                                </span>
                                <span class="summary-label" style="font-size: 10px; color: #666; margin-left: 2px">
                                    最长
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- 成就徽章区域 -->
                    <div class="collapsible-card glass-card" data-section="achievements">
                        <div class="card-header" onclick="App.toggleSection('achievements')">
                            <div class="header-left">
                                <span class="header-icon">🏆</span>
                                <span class="header-title">成就徽章</span>
                            </div>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="card-content collapsed" id="section-achievements">
                            <div class="achievements-grid" id="achievements-grid">
                            <div class="achievement-badge unlocked" data-achievement="first-book">
                                <div class="badge-icon">📚</div>
                                <div class="badge-name">初次阅读</div>
                                <div class="badge-desc">阅读第1本书</div>
                            </div>
                            <div class="achievement-badge" data-achievement="reader-week">
                                <div class="badge-icon">📖</div>
                                <div class="badge-name">七日坚持</div>
                                <div class="badge-desc">连续阅读7天</div>
                            </div>
                            <div class="achievement-badge" data-achievement="night-owl">
                                <div class="badge-icon">🦉</div>
                                <div class="badge-name">夜猫子</div>
                                <div class="badge-desc">深夜阅读</div>
                            </div>
                            <div class="achievement-badge" data-achievement="book-lover">
                                <div class="badge-icon">❤️</div>
                                <div class="badge-name">书虫</div>
                                <div class="badge-desc">阅读100本书</div>
                            </div>
                            <div class="achievement-badge" data-achievement="speed-reader">
                                <div class="badge-icon">⚡</div>
                                <div class="badge-name">速读达人</div>
                                <div class="badge-desc">单日阅读超5小时</div>
                            </div>
                            </div>
                        </div>
                    </div>

                    <!-- 数据统计仪表盘 -->
                    <div class="collapsible-card glass-card" data-section="user-stats">
                        <div class="card-header" onclick="App.toggleSection('user-stats')">
                            <div class="header-left">
                                <span class="header-icon">📊</span>
                                <span class="header-title">数据统计</span>
                            </div>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="card-content collapsed" id="section-user-stats">
                            <div class="stats-grid">
                            <div class="stat-card stat-card-gradient-1">
                                <div class="stat-icon-lg">📚</div>
                                <div class="stat-info">
                                    <div class="stat-value" id="stat-shared-books">0</div>
                                    <div class="stat-label">共享书籍</div>
                                </div>
                                <div class="stat-trend">+0</div>
                            </div>
                            <div class="stat-card stat-card-gradient-2">
                                <div class="stat-icon-lg">📝</div>
                                <div class="stat-info">
                                    <div class="stat-value" id="stat-shared-chapters">0</div>
                                    <div class="stat-label">共享章节</div>
                                </div>
                                <div class="stat-trend">+0</div>
                            </div>
                            <div class="stat-card stat-card-gradient-3">
                                <div class="stat-icon-lg">⏱️</div>
                                <div class="stat-info">
                                    <div class="stat-value" id="stat-reading-time">0h</div>
                                    <div class="stat-label">阅读时长</div>
                                </div>
                                <div class="stat-trend">+0h</div>
                            </div>
                            <div class="stat-card stat-card-gradient-4">
                                <div class="stat-icon-lg">📖</div>
                                <div class="stat-info">
                                    <div class="stat-value" id="stat-bookshelf">0</div>
                                    <div class="stat-label">书架书籍</div>
                                </div>
                                <div class="stat-trend">+0</div>
                            </div>
                            <div class="stat-card stat-card-gradient-5">
                                <div class="stat-icon-lg">⬇️</div>
                                <div class="stat-info">
                                    <div class="stat-value" id="stat-downloads">0</div>
                                    <div class="stat-label">下载次数</div>
                                </div>
                                <div class="stat-trend">+0</div>
                            </div>
                            <div class="stat-card stat-card-gradient-6">
                                <div class="stat-icon-lg">👀</div>
                                <div class="stat-info">
                                    <div class="stat-value" id="stat-total-books">0</div>
                                    <div class="stat-label">看过总数</div>
                                </div>
                                <div class="stat-trend">+0</div>
                            </div>
                            <div class="stat-card stat-card-gradient-1">
                                <div class="stat-icon-lg">🏆</div>
                                <div class="stat-info">
                                    <div class="stat-value" id="share-ranking">-</div>
                                    <div class="stat-label">分享排名</div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>

                    <!-- 订阅更新提醒 -->
                    <div
                        class="subscription-alert glass-card"
                        id="subscription-alert"
                        style="
                            display: none;
                            margin-bottom: 16px;
                            padding: 12px;
                            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
                            border-left: 4px solid #ff9800;
                            border-radius: 12px;
                        "
                    >
                        <div style="display: flex; align-items: center; gap: 10px">
                            <span style="font-size: 20px">🔔</span>
                            <div style="flex: 1">
                                <div style="font-weight: 600; color: #e65100; font-size: 14px">
                                    有
                                    <span id="alert-update-count">0</span>
                                    本订阅书籍更新了
                                </div>
                                <div style="font-size: 11px; color: #f57c00">点击查看详情</div>
                            </div>
                            <a
                                href="#subscriptions"
                                class="btn btn-sm"
                                style="background: #ff9800; color: white; border-radius: 8px; padding: 5px 10px; font-size: 12px"
                            >
                                查看更新
                            </a>
                        </div>
                    </div>

                    <!-- 快捷功能区域 -->
                    <!-- 已根据需求隐藏 -->
                    <div class="quick-actions-section" style="display: none;">
                        <div class="section-title-bar">
                            <h3 class="section-title">
                                <span class="title-icon">⚡</span>
                                快捷功能
                            </h3>
                        </div>
                        <div class="quick-actions-grid">
                            <div class="quick-action-card" id="quick-bookshelf">
                                <div class="action-icon">📖</div>
                                <div class="action-name">我的书架</div>
                                <div class="action-desc">查看正在阅读</div>
                            </div>
                            <div class="quick-action-card" id="quick-downloads">
                                <div class="action-icon">⬇️</div>
                                <div class="action-name">下载管理</div>
                                <div class="action-desc">管理下载任务</div>
                            </div>
                            <div class="quick-action-card" id="quick-subscriptions">
                                <div class="action-icon">🔔</div>
                                <div class="action-name">订阅管理</div>
                                <div class="action-desc">查看订阅更新</div>
                            </div>
                            <div class="quick-action-card" id="quick-library">
                                <div class="action-icon">🌐</div>
                                <div class="action-name">全站书库</div>
                                <div class="action-desc">浏览所有书籍</div>
                            </div>
                        </div>
                    </div>

                    <!-- 设置选项 - 折叠卡片形式 -->
                    <div class="collapsible-card glass-card" data-section="account-settings">
                        <div class="card-header" onclick="App.toggleSection('account-settings')">
                            <div class="header-left">
                                <span class="header-icon">⚙️</span>
                                <span class="header-title">账号设置</span>
                            </div>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="card-content collapsed" id="section-account-settings">
                            <div class="settings-list">
                                <div class="setting-item-new">
                                    <div class="setting-header" onclick="App.toggleSettingDetail('po18-detail')" style="cursor: pointer;">
                                        <div class="setting-info">
                                            <div class="setting-title">🔑 PO18 Cookie</div>
                                            <div class="setting-desc">配置PO18账号Cookie以获取已购书籍</div>
                                        </div>
                                        <span class="status-badge" id="po18-status">未设置</span>
                                    </div>
                                    <div class="setting-detail collapsed" id="po18-detail">
                                        <div class="form-group" style="margin-bottom: 12px;">
                                            <label style="font-size: 13px; color: var(--md-on-surface-variant); margin-bottom: 8px; display: block;">Cookie</label>
                                            <textarea
                                                id="po18-cookie"
                                                class="filter-textarea"
                                                rows="4"
                                                placeholder="粘贴PO18网站的Cookie..."
                                                style="font-size: 13px;"
                                            ></textarea>
                                        </div>
                                        <div class="cookie-status" id="cookie-status" style="margin-bottom: 12px; font-size: 13px;"></div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn btn-primary" onclick="App.savePO18Cookie()" style="flex: 1;">保存Cookie</button>
                                            <button class="btn btn-outline" onclick="App.validatePO18Cookie()" style="flex: 1;">验证Cookie</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="setting-item-new">
                                    <div class="setting-header" onclick="App.toggleSettingDetail('webdav-detail')" style="cursor: pointer;">
                                        <div class="setting-info">
                                            <div class="setting-title">☁️ WebDAV配置</div>
                                            <div class="setting-desc">连接个人云存储，自动上传书籍</div>
                                        </div>
                                        <span class="status-badge" id="webdav-status">未配置</span>
                                    </div>
                                    <div class="setting-detail collapsed" id="webdav-detail">
                                        <div id="webdav-list" style="margin-bottom: 16px;"></div>
                                        <div class="form-group" style="margin-bottom: 12px;">
                                            <label style="font-size: 13px; color: var(--md-on-surface-variant); margin-bottom: 8px; display: block;">书库名称</label>
                                            <input type="text" id="webdav-name" class="filter-textarea" placeholder="例如：坚果云" style="min-height: auto; height: 36px; padding: 8px 12px; font-size: 13px;" />
                                        </div>
                                        <div class="form-group" style="margin-bottom: 12px;">
                                            <label style="font-size: 13px; color: var(--md-on-surface-variant); margin-bottom: 8px; display: block;">服务器地址</label>
                                            <input type="text" id="webdav-url" class="filter-textarea" placeholder="https://dav.example.com" style="min-height: auto; height: 36px; padding: 8px 12px; font-size: 13px;" />
                                        </div>
                                        <div class="form-group" style="margin-bottom: 12px;">
                                            <label style="font-size: 13px; color: var(--md-on-surface-variant); margin-bottom: 8px; display: block;">用户名</label>
                                            <input type="text" id="webdav-username" class="filter-textarea" style="min-height: auto; height: 36px; padding: 8px 12px; font-size: 13px;" />
                                        </div>
                                        <div class="form-group" style="margin-bottom: 12px;">
                                            <label style="font-size: 13px; color: var(--md-on-surface-variant); margin-bottom: 8px; display: block;">密码</label>
                                            <input type="password" id="webdav-password" class="filter-textarea" style="min-height: auto; height: 36px; padding: 8px 12px; font-size: 13px;" />
                                        </div>
                                        <div class="form-group" style="margin-bottom: 12px;">
                                            <label style="font-size: 13px; color: var(--md-on-surface-variant); margin-bottom: 8px; display: block;">上传路径</label>
                                            <input type="text" id="webdav-path" class="filter-textarea" placeholder="/po18/" style="min-height: auto; height: 36px; padding: 8px 12px; font-size: 13px;" />
                                            <small style="font-size: 12px; color: var(--md-on-surface-variant); margin-top: 4px; display: block;">默认为 /po18/，书籍将保存在此目录</small>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn btn-primary" onclick="App.saveWebDAV()" style="flex: 1;">添加书库</button>
                                            <button class="btn btn-outline" onclick="App.testWebDAV()" style="flex: 1;">测试连接</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="setting-item-new">
                                    <div class="setting-header">
                                        <div class="setting-info">
                                            <div class="setting-title">🤝 共享设置</div>
                                            <div class="setting-desc">启用共享功能，与他人分享书籍</div>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="share-toggle">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="setting-item-new">
                                    <div class="setting-header" onclick="App.toggleFilterSettings()" style="cursor: pointer;">
                                        <div class="setting-info">
                                            <div class="setting-title">🎯 精华过滤</div>
                                            <div class="setting-desc">过滤不感兴趣的内容</div>
                                        </div>
                                        <label class="switch" onclick="event.stopPropagation();">
                                            <input type="checkbox" id="filter-enabled" onchange="App.toggleFilter(this.checked)">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                    <div class="setting-detail collapsed" id="filter-detail">
                                        <div class="filter-section">
                                            <label class="filter-label">屏蔽作者（逗号分隔）</label>
                                            <textarea id="filter-authors" class="filter-textarea" placeholder="例如：作者A,作者B"></textarea>
                                        </div>
                                        <div class="filter-section">
                                            <label class="filter-label">屏蔽关键词（逗号分隔）</label>
                                            <textarea id="filter-keywords" class="filter-textarea" placeholder="例如：关键词1,关键词2"></textarea>
                                        </div>
                                        <div class="filter-section">
                                            <label class="filter-label">屏蔽分类（逗号分隔）</label>
                                            <textarea id="filter-categories" class="filter-textarea" placeholder="例如：分类A,分类B"></textarea>
                                        </div>
                                        <div class="filter-section">
                                            <label class="switch-label">
                                                <input type="checkbox" id="filter-show-tip" checked>
                                                <span>显示过滤提示</span>
                                            </label>
                                        </div>
                                        <button class="btn btn-primary" onclick="App.saveFilterSettings()">保存过滤设置</button>
                                    </div>
                                </div>
                                <div class="setting-item-new" id="open-auth-settings">
                                    <div class="setting-header">
                                        <div class="setting-info">
                                            <div class="setting-title">🔒 鉴权设置</div>
                                            <div class="setting-desc">管理设备登录和会话安全</div>
                                        </div>
                                        <span class="status-badge" id="auth-status-badge">已启用</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 书单页 -->
                <section class="page" id="page-book-lists">
                    <div class="page-header">
                        <h2>📑 花间集</h2>
                        <p class="page-subtitle">创建和管理你的书单，分享给其他书友</p>
                    </div>

                    <!-- 书单标签页 -->
                    <div class="book-list-tabs" style="margin-bottom: 20px">
                        <button class="list-tab active" data-tab="my-lists">
                            📁 我的花笺
                        </button>
                        <button class="list-tab" data-tab="square">
                            🌐 花间广场
                        </button>
                        <button class="list-tab" data-tab="collected">
                            ⭐ 我的集藏
                        </button>
                        <button class="list-tab" data-tab="reviews">
                            📝 玉台语
                        </button>
                    </div>

                    <!-- 我的书单 -->
                    <div class="list-tab-content active" id="tab-my-lists">
                        <div class="list-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px">
                            <h3 style="margin: 0; font-size: 16px">📚 我创建的花笺</h3>
                            <button class="btn btn-primary btn-sm" id="btn-create-list">
                                <span>➕</span>
                                <span>创建花笺</span>
                            </button>
                        </div>
                        <div class="book-lists-grid" id="my-lists-grid">
                            <p class="empty-message">还没有创建花笺，点击上方按钮创建一个吧</p>
                        </div>
                    </div>

                    <!-- 书单广场 -->
                    <div class="list-tab-content" id="tab-square">
                        <div class="square-header" style="margin-bottom: 16px">
                            <div class="search-box" style="margin-bottom: 12px">
                                <input type="text" id="list-search-input" class="search-input" placeholder="觅花笺..." />
                                <button class="btn btn-primary btn-sm" id="btn-search-lists">🔍 搜索</button>
                            </div>
                            <div class="sort-tabs">
                                <button class="sort-tab active" data-sort="hot">🔥 热门</button>
                                <button class="sort-tab" data-sort="new">🆕 最新</button>
                                <button class="sort-tab" data-sort="collect">⭐ 收藏</button>
                            </div>
                        </div>
                        <div class="book-lists-grid" id="square-lists-grid">
                            <p class="empty-message">加载中...</p>
                        </div>
                    </div>

                    <!-- 我的收藏 -->
                    <div class="list-tab-content" id="tab-collected">
                        <div class="list-header" style="margin-bottom: 16px">
                            <h3 style="margin: 0; font-size: 16px">⭐ 我集藏的花笺</h3>
                        </div>
                        <div class="book-lists-grid" id="collected-lists-grid">
                            <p class="empty-message">还没有集藏花笺，去花间广场看看吧</p>
                        </div>
                    </div>

                    <!-- 书评 -->
                    <div class="list-tab-content" id="tab-reviews">
                        <div class="list-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px">
                            <h3 style="margin: 0; font-size: 16px">📝 玉台语</h3>
                            <button class="btn btn-primary btn-sm" id="btn-write-review">
                                <span>✏️</span>
                                <span>题评</span>
                            </button>
                        </div>
                        <div class="reviews-sort-tabs" style="margin-bottom: 16px">
                            <button class="sort-tab active" data-sort="latest">🕛 最新</button>
                            <button class="sort-tab" data-sort="hot">🔥 热门</button>
                            <button class="sort-tab" data-sort="rating">⭐ 高分</button>
                        </div>
                        <div class="reviews-list" id="reviews-list">
                            <p class="empty-message">加载中...</p>
                        </div>
                    </div>
                </section>
            </main>

            <!-- 底部 -->
            <footer class="footer">
                <p>荼蘼辞 &copy; 2024 | 仅供学习交流使用</p>
            </footer>
        </div>

        <!-- 登录/注册弹窗 -->
        <div class="modal-overlay" id="auth-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3 id="auth-modal-title">登录</h3>
                    <button class="modal-close" id="auth-modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="auth-form">
                        <div class="form-group">
                            <label for="auth-username">用户名</label>
                            <input type="text" id="auth-username" required minlength="3" />
                        </div>
                        <div class="form-group">
                            <label for="auth-password">密码</label>
                            <input type="password" id="auth-password" required minlength="6" />
                        </div>
                        <div class="form-error" id="auth-error"></div>
                        <button type="submit" class="btn btn-primary btn-block" id="auth-submit">登录</button>
                    </form>
                    <div class="auth-switch">
                        <span id="auth-switch-text">还没有账号？</span>
                        <a href="#" id="auth-switch-link">去注册</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑资料模态框 -->
        <div class="modal-overlay" id="profile-edit-modal" style="display: none">
            <div class="modal modal-lg">
                <div class="modal-header">
                    <h3>👤 编辑个人资料</h3>
                    <button class="modal-close" onclick="window.app.hideModal('profile-edit-modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>头像</label>
                        <div class="avatar-upload">
                            <div class="avatar-preview" id="avatar-preview">
                                <span class="avatar-text">📚</span>
                            </div>
                            <button class="btn btn-outline" id="upload-avatar-btn">上传头像</button>
                            <input type="file" id="avatar-file" accept="image/*" style="display: none" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="user-nickname">昵称</label>
                        <input type="text" id="user-nickname" class="md-input" placeholder="请输入昵称" />
                    </div>

                    <div class="form-group">
                        <label for="user-bio">个性签名</label>
                        <textarea
                            id="user-bio"
                            class="md-textarea"
                            rows="3"
                            placeholder="分享你的阅读心得..."
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="user-favorite-genres">喜爱的类型</label>
                        <select id="user-favorite-genres" class="md-select" multiple>
                            <option value="言情">言情</option>
                            <option value="玄幻">玄幻</option>
                            <option value="都市">都市</option>
                            <option value="仙侠">仙侠</option>
                            <option value="科幻">科幻</option>
                            <option value="悬疑">悬疑</option>
                            <option value="历史">历史</option>
                            <option value="军事">军事</option>
                            <option value="游戏">游戏</option>
                            <option value="体育">体育</option>
                        </select>
                        <div class="help-text">按住 Ctrl 可多选</div>
                    </div>

                    <div class="form-group">
                        <label>阅读偏好</label>
                        <div class="preference-options">
                            <label class="checkbox-option">
                                <input type="checkbox" id="pref-night-mode" />
                                <span class="checkmark"></span>
                                夜间模式默认开启
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" id="pref-auto-sync" />
                                <span class="checkmark"></span>
                                自动同步阅读进度
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" id="pref-push-notifications" />
                                <span class="checkmark"></span>
                                推送书籍更新通知
                            </label>
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 24px">
                        <button class="btn btn-primary btn-block" id="save-profile-btn">💾 保存资料</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 书籍详情弹窗 -->
        <div class="modal-overlay" id="book-modal">
            <div class="modal modal-lg">
                <div class="modal-header">
                    <h3 id="book-modal-title">书籍详情</h3>
                    <button class="modal-close" id="book-modal-close">&times;</button>
                </div>
                <div class="modal-body" id="book-modal-body">
                    <!-- 动态内容 -->
                </div>
            </div>
        </div>

        <!-- 书单创建/编辑弹窗 -->
        <div class="modal-overlay" id="book-list-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3 id="list-modal-title">📝 创建花笺</h3>
                    <button class="modal-close" onclick="App.hideModal('book-list-modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="book-list-form">
                        <input type="hidden" id="edit-list-id" />
                        
                        <div class="form-group">
                            <label for="list-name">花笺名称</label>
                            <input type="text" id="list-name" class="md-input" placeholder="例如：我的收藏、必读好书..." required />
                        </div>

                        <div class="form-group">
                            <label for="list-description">花笺简介</label>
                            <textarea id="list-description" class="md-textarea" rows="3" placeholder="介绍一下这个书单..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="list-cover">封面图片URL（可选）</label>
                            <input type="text" id="list-cover" class="md-input" placeholder="https://example.com/cover.jpg" />
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="list-is-public" checked />
                                <span>🌍 公开书单（其他用户可以查看）</span>
                            </label>
                        </div>

                        <div class="form-error" id="list-form-error"></div>
                        
                        <div class="button-group" style="display: flex; gap: 8px; margin-top: 16px">
                            <button type="button" class="btn btn-outline" onclick="App.hideModal('book-list-modal')">取消</button>
                            <button type="submit" class="btn btn-primary" id="save-list-btn">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 书单详情弹窗 -->
        <div class="modal-overlay" id="book-list-detail-modal" style="display: none">
            <div class="modal modal-lg">
                <div class="modal-header">
                    <h3 id="list-detail-title">书单详情</h3>
                    <button class="modal-close" onclick="App.hideModal('book-list-detail-modal')">&times;</button>
                </div>
                <div class="modal-body" id="list-detail-body">
                    <!-- 动态内容 -->
                </div>
            </div>
        </div>

        <!-- Toast消息 -->
        <div class="toast-container" id="toast-container"></div>

        <!-- 写书评弹窗 -->
        <div class="modal-overlay" id="review-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3 id="review-modal-title">✏️ 题玉台语</h3>
                    <button class="modal-close" onclick="App.hideModal('review-modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="review-form">
                        <div class="form-group">
                            <label>选择书籍（从书架）</label>
                            <select id="review-book-select" class="md-select">
                                <option value="">请选择书籍...</option>
                            </select>
                            <input type="hidden" id="review-book-id" />
                            <div id="selected-book-info" class="selected-book" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label>评分</label>
                            <div class="rating-stars" id="review-rating">
                                <span class="star" data-rating="1">☆</span>
                                <span class="star" data-rating="2">☆</span>
                                <span class="star" data-rating="3">☆</span>
                                <span class="star" data-rating="4">☆</span>
                                <span class="star" data-rating="5">☆</span>
                            </div>
                            <input type="hidden" id="review-rating-value" value="0" />
                        </div>
                        <div class="form-group">
                            <label for="review-content">评语</label>
                            <textarea id="review-content" class="md-textarea" rows="5" placeholder="分享你的阅读感受..."></textarea>
                        </div>
                        <div class="form-error" id="review-error"></div>
                        <button type="submit" class="btn btn-primary btn-block">发表评语</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 移动端底部Tab导航 -->
        <nav class="bottom-tab-bar" id="bottom-tab-bar">
            <a href="#" class="tab-item active" data-page="download">
                <span class="tab-icon">🌸</span>
                <span class="tab-label">春尽阁</span>
            </a>
            <a href="#" class="tab-item" data-page="bookshelf">
                <span class="tab-icon">📚</span>
                <span class="tab-label">芸香屉</span>
            </a>
            <a href="#" class="tab-item" data-page="rankings">
                <span class="tab-icon">🏆</span>
                <span class="tab-label">花事了</span>
            </a>
            <a href="#" class="tab-item" data-page="global-library" id="tab-global-library" style="display: none">
                <span class="tab-icon">🌐</span>
                <span class="tab-label">琅嬛录</span>
            </a>
            <a href="#" class="tab-item" data-page="subscriptions" id="tab-subscriptions">
                <span class="tab-icon">🔔</span>
                <span class="tab-label">青鸟约</span>
                <span class="tab-badge" id="tab-subscription-badge">0</span>
            </a>
            <a href="#" class="tab-item" data-page="settings">
                <span class="tab-icon">👤</span>
                <span class="tab-label">镜里妆</span>
            </a>
        </nav>

        <!-- 延迟加载 JSZip 库，仅在需要时加载 -->
        <!-- <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script> -->
        <script src="js/performance-optimizer.js?v=20251224e"></script>
        <script src="js/utils.js?v=20251224e"></script>
        <script src="js/mobile-enhancements.js?v=20251224e"></script>
        <script src="js/app-enhancements.js?v=20251224e"></script>
        <script src="js/generator.js?v=20251224e"></script>
        <script src="js/api.js?v=20251224e"></script>
        <script src="js/mobile.js?v=20251224e"></script>
        <script src="js/app.js?v=20251224e"></script>
        <script src="js/smart-bookshelf.js?v=20251224e"></script>
        
        <!-- 确保智能书架正确初始化 -->
        <script>
            // 立即强制隐藏旧容器
            (function() {
                function hideOldContainer() {
                    const oldContainer = document.getElementById('bookshelf-list');
                    if (oldContainer && document.getElementById('bookshelf-container')) {
                        oldContainer.style.display = 'none';
                        oldContainer.style.visibility = 'hidden';
                        oldContainer.style.position = 'absolute';
                        oldContainer.style.left = '-9999px';
                    }
                }
                
                // 立即执行
                hideOldContainer();
                
                // DOM加载后再次执行
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', hideOldContainer);
                }
                
                // 页面完全加载后再次执行
                window.addEventListener('load', function() {
                    hideOldContainer();
                    setTimeout(function() {
                        hideOldContainer();
                        // 如果书架数据已加载，触发渲染
                        if (window.App && window.App.bookshelfData) {
                            if (window.SmartBookshelf && window.SmartBookshelf.render) {
                                window.SmartBookshelf.render();
                            }
                        }
                    }, 200);
                });
                
                // 定期检查并隐藏（防止被其他脚本显示）
                setInterval(hideOldContainer, 500);
            })();
        </script>
        <script src="js/final-enhancements.js?v=20251224e"></script>

        <!-- PWA Service Worker 注册 -->
        <script>
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker
                        .register("/service-worker.js")
                        .then((registration) => {
                            console.log("SW registered:", registration.scope);
                            
                            // 检查更新
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'activated') {
                                        console.log('[SW] 新版本已激活，准备刷新页面');
                                        // 如果有新的 Service Worker 激活，刷新页面
                                        if (navigator.serviceWorker.controller) {
                                            window.location.reload();
                                        }
                                    }
                                });
                            });
                        })
                        .catch((err) => {
                            console.log("SW registration failed:", err);
                        });
                });
            }
            
            // 修复页面初始化滑动问题
            document.addEventListener('DOMContentLoaded', () => {
                // 确保 body 和根元素样式正确
                document.body.style.overflow = 'auto';
                document.documentElement.style.overflow = 'auto';
                
                // 触发一次重排以修复潜在的渲染问题
                setTimeout(() => {
                    document.body.style.display = 'none';
                    document.body.offsetHeight; // 触发重排
                    document.body.style.display = '';
                }, 100);
            });
        </script>
    </body>
</html>